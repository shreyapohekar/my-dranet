<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>GKE and Cloud TPU v6e (Trillium) | DRANET</title>
<meta name=description content="If you use TPU Trillium and you want to improve the network performance of your Pods you can balance your network traffic over the VM NICs.
The ct6e-standard-4t machine type is backed by two physical NICs, since the main interface of the VM is used for all the applications and Pods on the host, you can create two additional vNICs on the VM that will be attached to each of the physical NICs, and pass them to the Pod directly, so you can multiplex your traffic to consume the total capacity of the physical NICs."><meta property="og:url" content="https://dranet.dev/docs/user/gke-tpu-performance/"><meta property="og:site_name" content="DRANET"><meta property="og:title" content="GKE and Cloud TPU v6e (Trillium)"><meta property="og:description" content="If you use TPU Trillium and you want to improve the network performance of your Pods you can balance your network traffic over the VM NICs.
The ct6e-standard-4t machine type is backed by two physical NICs, since the main interface of the VM is used for all the applications and Pods on the host, you can create two additional vNICs on the VM that will be attached to each of the physical NICs, and pass them to the Pod directly, so you can multiplex your traffic to consume the total capacity of the physical NICs."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-05-27T11:30:40+00:00"><meta property="article:modified_time" content="2025-05-27T11:30:40+00:00"><meta itemprop=name content="GKE and Cloud TPU v6e (Trillium)"><meta itemprop=description content="If you use TPU Trillium and you want to improve the network performance of your Pods you can balance your network traffic over the VM NICs.
The ct6e-standard-4t machine type is backed by two physical NICs, since the main interface of the VM is used for all the applications and Pods on the host, you can create two additional vNICs on the VM that will be attached to each of the physical NICs, and pass them to the Pod directly, so you can multiplex your traffic to consume the total capacity of the physical NICs."><meta itemprop=datePublished content="2025-05-27T11:30:40+00:00"><meta itemprop=dateModified content="2025-05-27T11:30:40+00:00"><meta itemprop=wordCount content="839"><meta name=twitter:card content="summary"><meta name=twitter:title content="GKE and Cloud TPU v6e (Trillium)"><meta name=twitter:description content="If you use TPU Trillium and you want to improve the network performance of your Pods you can balance your network traffic over the VM NICs.
The ct6e-standard-4t machine type is backed by two physical NICs, since the main interface of the VM is used for all the applications and Pods on the host, you can create two additional vNICs on the VM that will be attached to each of the physical NICs, and pass them to the Pod directly, so you can multiplex your traffic to consume the total capacity of the physical NICs."><link rel=preload href=/scss/main.min.3bb6570761fbbb25e6691001febc67f331f0953db4e4e1cfb79172c2e6a5819e.css as=style integrity="sha256-O7ZXB2H7uyXmaRAB/rxn8zHwlT205OHPt5FywualgZ4=" crossorigin=anonymous><link href=/scss/main.min.3bb6570761fbbb25e6691001febc67f331f0953db4e4e1cfb79172c2e6a5819e.css rel=stylesheet integrity="sha256-O7ZXB2H7uyXmaRAB/rxn8zHwlT205OHPt5FywualgZ4=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YH3W884R6Z"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YH3W884R6Z")}</script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>DRANET</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/docs/user><span>User Guides</span></a></li><li class=nav-item><a class=nav-link href=/docs/concepts><span>Concepts</span></a></li><li class=nav-item><a class=nav-link href=/docs/contributing><span>Contributing</span></a></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>DRANET</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsquick-start-li><a href=/docs/quick-start/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsquick-start><span>Quick Start</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsuser-li><a href=/docs/user/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsuser><span>User Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsuserkuberay-li><a href=/docs/user/kuberay/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsuserkuberay><span>Ray on GKE using DRANET</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsusernvidia-dranet-li><a href=/docs/user/nvidia-dranet/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsusernvidia-dranet><span>GKE with NVIDIA DRA and DRANET</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsusergke-tpu-performance-li><a href=/docs/user/gke-tpu-performance/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-docsusergke-tpu-performance><span class=td-sidebar-nav-active-item>GKE and Cloud TPU v6e (Trillium)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsusergke-rdma-li><a href=/docs/user/gke-rdma/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsusergke-rdma><span>GKE and GPUDirect RDMA with DRA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsusermpi-operator-li><a href=/docs/user/mpi-operator/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsusermpi-operator><span>MPI Operator on GKE and GPUDirect RDMA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsuserinterface-configuration-li><a href=/docs/user/interface-configuration/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsuserinterface-configuration><span>Interface Configuration</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsconcepts-li><a href=/docs/concepts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docsconcepts><span>Concepts</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptslinux-network-interfaces-li><a href=/docs/concepts/linux-network-interfaces/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptslinux-network-interfaces><span>Linux Network Namespaces and Interfaces</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsflexible-networks-li><a href=/docs/concepts/flexible-networks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsflexible-networks><span>Making Networks Flexible</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsinterface-status-li><a href=/docs/concepts/interface-status/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsinterface-status><span>Interface Status</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptshardware-efficiency-li><a href=/docs/concepts/hardware-efficiency/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptshardware-efficiency><span>Hardware Efficiency</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsrdma-li><a href=/docs/concepts/rdma/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsrdma><span>RDMA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsrdma-modes-li><a href=/docs/concepts/rdma-modes/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsrdma-modes><span>RDMA Device Handling</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptshowitworks-li><a href=/docs/concepts/howitworks/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptshowitworks><span>How It Works</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsconceptsreferences-li><a href=/docs/concepts/references/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docsconceptsreferences><span>References</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li><a href=/docs/contributing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingdeveloper-guide-li><a href=/docs/contributing/developer-guide/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdeveloper-guide><span>Developer Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingcontributing-li><a href=/docs/contributing/contributing/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingcontributing><span>Contributing</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"><a href=https://github.com/google/dranet/tree/main/site/content/docs/user/gke-tpu-performance.md class="td-page-meta--view td-page-meta__view" target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/google/dranet/edit/main/site/content/docs/user/gke-tpu-performance.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/google/dranet/new/main/site/content/docs/user?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/google/dranet/issues/new?title=GKE%20and%20Cloud%20TPU%20v6e%20%28Trillium%29" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>DRANET</a></li><li class=breadcrumb-item><a href=/docs/user/>User Guides</a></li><li class="breadcrumb-item active" aria-current=page>GKE and Cloud TPU v6e (Trillium)</li></ol></nav><div class=td-content><h1>GKE and Cloud TPU v6e (Trillium)</h1><header class=article-meta></header><p>If you use TPU Trillium and you want to improve the network performance of your Pods you can balance your network traffic over the VM NICs.</p><p>The <code>ct6e-standard-4t</code> machine type is backed by two physical NICs, since the main interface of the VM is used for all the applications and Pods on the host, you can create two additional vNICs on the VM that will be attached to each of the physical NICs, and pass them to the Pod directly, so you can multiplex your traffic to consume the total capacity of the physical NICs.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:green># Create two additional VPC networks</span>
</span></span><span style=display:flex><span>gcloud compute --project=<span style=color:#a31515>${</span>PROJECT?<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  networks create <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  tpu-net-1 <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --mtu=8896 <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --subnet-mode=custom
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute --project=<span style=color:#a31515>${</span>PROJECT?<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  networks subnets create <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  tpu-net-1-sub <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --network=tpu-net-1 <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --region=<span style=color:#a31515>${</span>REGION?<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --range=192.168.0.0/24
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute --project=<span style=color:#a31515>${</span>PROJECT?<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  networks create <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  tpu-net-2 <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --mtu=8896 <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --subnet-mode=custom
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute --project=<span style=color:#a31515>${</span>PROJECT?<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  networks subnets create <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  tpu-net-2-sub <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --network=tpu-net-2 <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --region=<span style=color:#a31515>${</span>REGION?<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>  --range=192.168.1.0/24
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud container node-pools create POOL_NAME <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --location=<span style=color:#a31515>${</span>LOCATION<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --cluster=<span style=color:#a31515>${</span>CLUSTER_NAME<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --node-locations=<span style=color:#a31515>${</span>NODE_ZONES<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --machine-type=<span style=color:#a31515>${</span>MACHINE_TYPE<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --tpu-topology=<span style=color:#a31515>${</span>TPU_TOPOLOGY<span style=color:#a31515>}</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --additional-node-network network=tpu-net-1,subnetwork=tpu-net-1-sub <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --additional-node-network network=tpu-net-2,subnetwork=tpu-net-2-sub <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    --enable-gvnic
</span></span></code></pre></div><p>Apply the following manifest to install DRANET:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/google/dranet/refs/heads/main/install.yaml
</span></span></code></pre></div><p>Once DRANET is running you&rsquo;ll be able to obtain the network resources exposed by the dranet Pods, in order to avoid noise, DRANET has a flag that allow to set client side filter to control the exposed resources, in this case, we can set the flag to ignore network devices that are <code>virtual</code>, the manifest will look like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - args:
</span></span><span style=display:flex><span>        - /dranet
</span></span><span style=display:flex><span>        - --v=4
</span></span><span style=display:flex><span>        - --filter=attributes[&#34;dra.net/virtual&#34;].BoolValue == false
</span></span><span style=display:flex><span>       image: ghcr.io/google/dranet:stable
</span></span></code></pre></div><p>First, we tell DRANET what kind of NICs we&rsquo;re interested in and how Pods can claim them. In order to simplify our workloads we can create a <code>DeviceClass</code> that matches only the resources exposed by DRANET.</p><p><strong>DeviceClass (dranet):</strong> This selects NICs managed by DRANET.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: resource.k8s.io/v1
</span></span><span style=display:flex><span>kind: DeviceClass
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: dranet
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  selectors:
</span></span><span style=display:flex><span>    - cel:
</span></span><span style=display:flex><span>        expression: device.driver == &#34;dra.net&#34;
</span></span></code></pre></div><p><strong>ResourceClaimTemplate (worker-rdma-nic-template):</strong> This will request the two additional NICs, since we created the additiona networks with the prefix <code>tpu-net</code> we can levarage the powerful CEL expressions to match on that prefix.</p><p>Another important factor is the capacity of DRANET to pass Interface configuration options that allow to tune the interfaces for maximum performance, per example, <a href=https://lwn.net/Articles/884104/>Big TCP</a>.</p><p>In addition, if you have GVNIC enabled you can use some private ethtool flags that improve the performance for TCP like <a href=enable-max-rx-buffer-size>enable-max-rx-buffer-size</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: resource.k8s.io/v1
</span></span><span style=display:flex><span>kind: ResourceClaimTemplate
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: tpu-net-interfaces
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  spec:
</span></span><span style=display:flex><span>    devices:
</span></span><span style=display:flex><span>      requests:
</span></span><span style=display:flex><span>      - name: tpu-net-interface
</span></span><span style=display:flex><span>        exactly:
</span></span><span style=display:flex><span>          deviceClassName: dranet
</span></span><span style=display:flex><span>          count: 2
</span></span><span style=display:flex><span>          selectors:
</span></span><span style=display:flex><span>          - cel:
</span></span><span style=display:flex><span>              expression: device.attributes[&#34;gce.dra.net&#34;].networkName.startsWith(&#34;tpu-net&#34;)
</span></span><span style=display:flex><span>      config:
</span></span><span style=display:flex><span>      - opaque:
</span></span><span style=display:flex><span>          driver: dra.net
</span></span><span style=display:flex><span>          parameters:
</span></span><span style=display:flex><span>            interface:
</span></span><span style=display:flex><span>              mtu: 8896
</span></span><span style=display:flex><span>              gsoMaxSize: 65536
</span></span><span style=display:flex><span>              groMaxSize: 65536
</span></span><span style=display:flex><span>              gsoIPv4MaxSize: 65536
</span></span><span style=display:flex><span>              groIPv4MaxSize: 65536
</span></span><span style=display:flex><span>              disableEbpfPrograms: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>            ethtool:
</span></span><span style=display:flex><span>              privateFlags:
</span></span><span style=display:flex><span>                enable-max-rx-buffer-size: <span style=color:#00f>true</span>
</span></span></code></pre></div><p>To test the network performance we&rsquo;ll use <a href=https://github.com/google/neper>neper</a>, a tool created by the Google kernel teams to test network performance.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: StatefulSet
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: neper
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: neper
</span></span><span style=display:flex><span>  serviceName: neper
</span></span><span style=display:flex><span>  replicas: 2
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: neper
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      nodeSelector:
</span></span><span style=display:flex><span>        cloud.google.com/gke-tpu-accelerator: tpu-v6e-slice
</span></span><span style=display:flex><span>        cloud.google.com/gke-tpu-topology: 4x4
</span></span><span style=display:flex><span>      initContainers:
</span></span><span style=display:flex><span>      - name: <span style=color:#a31515>&#34;network-optimization-sysctls&#34;</span>
</span></span><span style=display:flex><span>        image: <span style=color:#a31515>&#34;busybox&#34;</span>
</span></span><span style=display:flex><span>        securityContext:
</span></span><span style=display:flex><span>          privileged: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        command:
</span></span><span style=display:flex><span>        - sh
</span></span><span style=display:flex><span>        - -c
</span></span><span style=display:flex><span>        - |<span style=color:#a31515>
</span></span></span><span style=display:flex><span><span style=color:#a31515>          echo 5000 &gt; /proc/sys/net/ipv4/tcp_rto_min_us
</span></span></span><span style=display:flex><span><span style=color:#a31515>          echo 1 &gt; /proc/sys/net/ipv4/tcp_no_metrics_save
</span></span></span><span style=display:flex><span><span style=color:#a31515>          echo 0 &gt; /proc/sys/net/ipv4/tcp_slow_start_after_idle
</span></span></span><span style=display:flex><span><span style=color:#a31515>          echo 131072 &gt; /proc/sys/net/core/optmem_max
</span></span></span><span style=display:flex><span><span style=color:#a31515>          echo &#34;4096 41943040 314572800&#34; &gt; /proc/sys/net/ipv4/tcp_rmem</span>          
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - name: neper
</span></span><span style=display:flex><span>        image: ghcr.io/google/neper:stable
</span></span><span style=display:flex><span>        securityContext:
</span></span><span style=display:flex><span>          privileged: <span style=color:#00f>true</span>
</span></span><span style=display:flex><span>        resources:
</span></span><span style=display:flex><span>          requests:
</span></span><span style=display:flex><span>            google.com/tpu: 4
</span></span><span style=display:flex><span>          limits:
</span></span><span style=display:flex><span>            google.com/tpu: 4
</span></span><span style=display:flex><span>      resourceClaims:
</span></span><span style=display:flex><span>      - name: tpu-net-interface
</span></span><span style=display:flex><span>        resourceClaimTemplateName: tpu-net-interfaces
</span></span></code></pre></div><p>We&rsquo;ll get two pods running:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl get pods
</span></span><span style=display:flex><span>NAME      READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>neper-0   1/1     Running   0          10m
</span></span><span style=display:flex><span>neper-1   1/1     Running   0          22s
</span></span></code></pre></div><p>Using neper-1 as a server <code>kubectl exec -it neper-1 -- sh</code>, checks first the additional IPs assigned, in this case these IPs are 10.9.9.11 and 10.10.0.11</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: eth0@if13: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1460 qdisc noqueue state UP qlen 1000
</span></span><span style=display:flex><span>    link/ether 16:41:72:68:11:67 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 10.68.2.12/24 brd 10.68.2.255 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8896 qdisc mq state UP qlen 1000
</span></span><span style=display:flex><span>    link/ether 42:01:0a:09:09:0b brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 10.9.9.11/32 scope global eth1
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>4: eth2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8896 qdisc mq state UP qlen 1000
</span></span><span style=display:flex><span>    link/ether 42:01:0a:0a:00:0b brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 10.10.0.11/32 scope global eth2
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>then run one TCP stream server per NIC:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#00f>for</span> i in 0 1; <span style=color:#00f>do</span>
</span></span><span style=display:flex><span>  tcp_stream -C<span style=color:#00f>$((</span>52279 + i<span style=color:#00f>))</span> --port=<span style=color:#00f>$((</span>38339 + i<span style=color:#00f>))</span> --skip-rx-copy -rw -Z -B16384 --test-length=60 --suicide-length=120 -F100 --num-threads=16 --num-flows=32 -D0 --logtostderr &amp;&gt; test$i.log &amp;
</span></span><span style=display:flex><span><span style=color:#00f>done</span>
</span></span></code></pre></div><p>and neper-0 as a client <code>kubectl exec -it neper-0 -- sh</code> to connect to each TCP server:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tcp_stream -C52279 --port=38339 --skip-rx-copy -rw -Z -B16384 --test-length=60 --suicide-length=70 -F100 --num-threads=16 --num-flows=32 --client -H 10.9.9.11 -D0 --logtostderr &amp;&gt; test0.log &amp;
</span></span><span style=display:flex><span>tcp_stream -C52280 --port=38340 --skip-rx-copy -rw -Z -B16384 --test-length=60 --suicide-length=70 -F100 --num-threads=16 --num-flows=32 --client -H 10.10.0.11 -D0 --logtostderr &amp;&gt; test1.log &amp;
</span></span></code></pre></div><p>The first test instance recorded a throughput of ~180.17 Gbps, and the second instance simultaneously achieved ~174.73 Gbps.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep throughput test*
</span></span><span style=display:flex><span>test0.log:throughput_opt=Mb
</span></span><span style=display:flex><span>test0.log:throughput=180165.51
</span></span><span style=display:flex><span>test0.log:throughput_units=Mbit/s
</span></span><span style=display:flex><span>test0.log:local_throughput=180165511242
</span></span><span style=display:flex><span>test0.log:remote_throughput=177503231653
</span></span><span style=display:flex><span>test1.log:throughput_opt=Mb
</span></span><span style=display:flex><span>test1.log:throughput=174727.08
</span></span><span style=display:flex><span>test1.log:throughput_units=Mbit/s
</span></span><span style=display:flex><span>test1.log:local_throughput=174727081480
</span></span><span style=display:flex><span>test1.log:remote_throughput=175469311719
</span></span></code></pre></div><p>The sum of these two independent tests gives the total aggregated throughput of 354.9 Gbps.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="SIG Network mailing list" aria-label="SIG Network mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/kubernetes-sig-network aria-label="SIG Network mailing list"><i class="fa fa-envelope"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/google/dranet aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://kubernetes.slack.com/messages/sig-network aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024&ndash;2025
<span class=td-footer__authors>Google LLC | <a href=https://creativecommons.org/licenses/by/4.0>CC BY 4.0</a> |</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.min.d9615597e83c4193e3ab1e6816bad5c8741894e92c5b5c17a8d1d4be6d9af8a2.js integrity="sha256-2WFVl+g8QZPjqx5oFrrVyHQYlOksW1wXqNHUvm2a+KI=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>